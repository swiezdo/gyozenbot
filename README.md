# Gyozen Bot

Telegram бот для игры Ghost of Tsushima: Legends с AI-функциональностью и интеграцией с Mini App.

## Описание

Этот бот предоставляет:
- Диалоги с персонажем Gyozen в стиле игры (через AI)
- Генерацию изображений через DALL·E
- Информацию о волнах Survival
- Интеграцию с Mini App (открытие WebApp, работа с билдами)
- Команду для просмотра профилей пользователей
- Inline поиск билдов
- Автоматические утренние приветствия

## Технологии

- **Python 3.8+**
- **aiogram 3.x** - библиотека для работы с Telegram Bot API
- **OpenAI API** - для генерации текста и изображений
- **DeepSeek API** - альтернативный AI провайдер
- **miniapp_api REST API** - асинхронное взаимодействие с сервером miniapp_api

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd gyozenbot
```

2. Создайте виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate     # Windows
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Настройте переменные окружения:
Создайте файл `.env` в корне проекта:
```env
BOT_TOKEN=your_telegram_bot_token
OPENAI_API_KEY=your_openai_api_key
DEEPSEEK_API_KEY=your_deepseek_api_key  # опционально
AI_PROVIDER=openai  # или deepseek
```

## Запуск

```bash
python main.py
```

## Функциональность

### Диалоги с Гёдзеном

- **Активация**: отвечает на сообщения, содержащие слово "гёдзен" (в разных вариациях)
- **Контекст**: работает только в определенной группе и теме
- **AI провайдеры**: OpenAI (GPT-4o) или DeepSeek
- **Стиль**: использует специальный промпт для имитации персонажа из игры
- **Fine-tuned модели**: поддерживает использование fine-tuned моделей OpenAI

### Генерация изображений

- **Модель**: DALL·E 3
- **Размер**: 1024x1024
- **Интеграция**: через команды в диалогах с Гёдзеном

### Информация о волнах

- **Команда `/waves`**: интерактивное меню с данными выжившего режима
- **Редактирование**: доступно администраторам через inline-кнопки
- **Данные**: хранятся в `json/waves.json` и `json/waves_data.json`

### Интеграция с Mini App

- **Команда `/start`**: открывает Mini App через WebApp кнопку
- **Команда `/build <ID>`**: получает и показывает билд по ID
- **Callback queries**: обработка одобрения/отклонения заявок на мастерство
- **Inline queries**: поиск билдов через inline режим

### Профили пользователей

- **Команда `!п`**: показывает скриншот профиля пользователя
- **Контекст**: работает только в разрешенных группах
- **Логика**: 
  - Если reply на сообщение → показывает профиль автора того сообщения
  - Если просто команда → показывает профиль автора команды
- **Технически**: создает скриншот через API miniapp_api и отправляет в группу

### Планировщик

- **Утренние приветствия**: автоматическая отправка в 9:00 МСК ежедневно
- **Запуск**: параллельно с основным polling

## Структура проекта

```
gyozenbot/
├── handlers/           # Обработчики команд и сообщений
│   ├── gyozen.py      # Диалоги с Гёдзеном
│   ├── miniapp.py     # Интеграция с Mini App
│   ├── profile.py     # Команда !п (профили)
│   ├── inline.py      # Inline queries для поиска билдов
│   ├── scheduler.py   # Планировщик утренних приветствий
│   └── waves_new.py   # Команда /waves
├── main.py            # Главный файл запуска
├── config.py          # Конфигурация
├── ai_client.py       # Клиент для AI сервиса
├── api_client.py      # Простая обертка для miniapp_api
├── image_generator.py # Генерация изображений
├── dialogue_styles.py # Стили диалогов
├── waiting_phrases.py # Фразы ожидания
├── json/              # Данные бота
│   ├── rotation.json  # Информация о ротациях
│   └── waves.json     # Данные о волнах
├── requirements.txt   # Зависимости
└── CONTEXT.md         # Контекст для AI-ассистента
```

## Конфигурация

Основные настройки в `config.py`:

- **BOT_TOKEN** - токен Telegram бота (из .env)
- **GROUP_ID** - ID основной группы
- **GYOZEN_TOPIC_ID** - ID темы для диалогов с Гёдзеном
- **TROPHY_GROUP_CHAT_ID** - ID группы для трофеев
- **CONGRATULATION_GROUP_ID** - ID чата, куда бот отправляет поздравления (по умолчанию = TROPHY_GROUP_CHAT_ID или GROUP_ID)
- **MINI_APP_URL** - URL Mini App
- **API_BASE_URL** - URL API miniapp_api
- **AI_PROVIDER** - провайдер AI ("openai" или "deepseek")
- **OPENAI_API_KEY** - ключ OpenAI (из .env)
- **DEEPSEEK_API_KEY** - ключ DeepSeek (из .env)

## Интеграции

### miniapp_api

- **REST API**: получение данных билдов, создание скриншотов профилей, управление заявками
- **Асинхронный HTTP-клиент**: `api_client.py` оборачивает запросы через `aiohttp` с повторным использованием токена
- **Общий BOT_TOKEN**: один токен используется и gyozenbot, и miniapp_api

### tsushimaru_app

- **WebApp**: открывается через WebApp кнопку в Telegram
- **Взаимодействие**: только через REST API miniapp_api

## Безопасность

- Хранение токенов в переменных окружения (.env)
- Валидация контекста для команд (проверка групп, тем)
- Ограничение доступа к командам (только для админов, только в разрешенных группах)

## Развертывание

Для развертывания на сервере рекомендуется использовать:
- systemd сервис для автозапуска
- Логирование в файлы
- Мониторинг через systemctl status

## Дополнительная информация

Для более детальной информации о работе с проектом см. [CONTEXT.md](CONTEXT.md) - файл с контекстом для AI-ассистента.

## Лицензия

MIT License
